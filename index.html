<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>HIGHER MATCH</title>
<!-- âœ… Google Fonts: Do Hyeon -->
<link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap" rel="stylesheet">
<style>
  :root{
    --navy:#0c1a3a;
    --yellow:#ffd94d;
    --bg:#0f1730;
    --card:#131e3f;
    --text:#f4f6ff;
    --muted:#97a2c9;
    --danger:#ff6b6b;
    --success:#2dd4bf;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:linear-gradient(180deg,var(--bg),#0a142e 55%,#08102a);
    color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Helvetica,Arial,sans-serif;
  }
  .container{max-width:480px;margin:0 auto;padding:16px 14px 28px}
  .card{
    background:rgba(19,30,63,.7);
    backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,.06);
    border-radius:16px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  h1,h2,h3{margin:0 0 14px}
  h1.title{
    font-size:28px; letter-spacing:.8px; text-align:center; margin-top:8px;
    background:linear-gradient(90deg,#fff,var(--yellow)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    /* âœ… Do Hyeon í°íŠ¸ ì ìš© */
    font-family: 'Do Hyeon', sans-serif;
  }
  .page-title{
    text-align:center; font-size:22px; margin-bottom:8px;
    /* âœ… Do Hyeon í°íŠ¸ ì ìš© */
    font-family: 'Do Hyeon', sans-serif;
  }
  .subtitle{color:var(--muted); font-size:13px; text-align:center; margin-top:-6px; margin-bottom:14px}

  /* ë¡œê³  */
  .logo-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;margin:8px 0 16px}
  .logo{
    width:240px;height:auto;object-fit:contain;display:block;border-radius:12px;border:1px dashed rgba(255,255,255,.15);background:#0b1532;
  }
  .logo-mini{ /* ê¸°ëŠ¥ í˜ì´ì§€ ìƒë‹¨ ë¡œê³  */
    width:200px;height:auto;object-fit:contain;display:block;border-radius:12px;border:1px dashed rgba(255,255,255,.15);background:#0b1532;margin:0 auto 6px;
  }

  .row{display:flex;gap:10px}
  input,button,textarea,select{
    width:100%; padding:14px 13px; border-radius:12px;
    border:1px solid rgba(255,255,255,.08); background:#0b1532; color:#f4f6ff; font-size:16px;
  }
  input::placeholder,textarea::placeholder{color:#7e8bb8}
  textarea{resize:none; min-height:90px}
  button{cursor:pointer; font-weight:700; letter-spacing:.2px}
  .btn{background:#13265a}
  .btn:hover{filter:brightness(1.06)}
  .btn-primary{background:var(--yellow); color:#1a1a1a; border-color:#0000}
  .btn-accent{background:#1a2b63; border:1px solid #2a3b7a}
  .btn-like{background:#1c2f6e; border:1px solid #2e4aa7}
  .btn-focus{outline:2px solid var(--yellow)}
  .btn-danger{background:var(--danger)}
  .btn-success{background:var(--success); color:#0e2824}

  .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .tile{
    display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:center;
    padding:18px 12px; border-radius:14px; text-align:center; min-height:100px; background:#0f1f4b; border:1px solid rgba(255,255,255,.06)
  }
  .tile strong{font-size:16px; /* âœ… Do Hyeon í°íŠ¸ ì ìš© */ font-family:'Do Hyeon', sans-serif;}
  .tile.like{background:#14265a; border:1px solid #29418d; box-shadow:0 0 0 2px rgba(41,65,141,.25) inset}
  /* âœ… ë©”ë‰´ì˜ LIKE íƒ€ì¼ í…ìŠ¤íŠ¸ë§Œ ë…¸ë€ìƒ‰ */
  .tile.like strong{ color: var(--yellow); }

  .muted{color:var(--muted); font-size:13px}
  .small{font-size:12px}
  .center{text-align:center}
  .spacer{height:8px}
  .footerbar{
    margin-top:16px; display:flex; align-items:center; justify-content:space-between; gap:10px; color:var(--muted); font-size:12px
  }
  .list{display:flex;flex-direction:column; gap:10px}
  .list-item{
    display:flex; align-items:center; gap:10px;
    padding:12px; border-radius:12px; background:#0d1a3e; border:1px solid rgba(255,255,255,.06)
  }
  .hidden{display:none !important}

  /* â€œë‹¤ë¥¸ì‚¬ëŒ êµ¬ê²½í•˜ê¸°â€ í–‰ ë ˆì´ì•„ì›ƒ: ë‚´ìš© 2/3, ë²„íŠ¼ 1/3 */
  .li-content{ flex: 2; min-width:0; }
  .li-actions{ flex: 1; display:flex; justify-content:flex-end; align-items:stretch; }
  .li-actions .btn-like{ width:100%; }

  /* modal */
  .modal-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:50
  }
  .modal{width:90%; max-width:420px; background:#0d1534; border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:16px}
  .modal h3{margin:0 0 8px}
  .modal .actions{display:flex; gap:10px; margin-top:12px}

  /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
  .loading-backdrop{
    position:fixed; inset:0; background:rgba(0,0,0,.35);
    display:none; align-items:center; justify-content:center; z-index:60;
  }
  .loading-box{
    background:#0d1534; border:1px solid rgba(255,255,255,.12);
    padding:14px 16px; border-radius:12px; font-size:14px;
    display:flex; align-items:center; gap:10px;
  }
  .spinner{
    width:16px; height:16px; border:3px solid rgba(255,255,255,.2); border-top-color:#fff;
    border-radius:50%; animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>
<div class="container">

  <!-- ===== [PAGE] ì²«í˜ì´ì§€ ===== -->
  <section id="page-welcome" class="card">
    <div class="logo-wrap">
      <img id="logo-main" class="logo" src="https://lh3.googleusercontent.com/d/143lu87wt27PIerpMbBNSViSsHabI0dZd" alt="HIGHER MATCH ë¡œê³ " />
    </div>
    <h1 class="title">HIGHERì—ì„œ ì¸ì—° ì°¾ê¸°</h1>
    <div class="spacer"></div>
    <div class="row">
      <input id="login-uid" inputmode="numeric" pattern="[0-9]*" placeholder="ë‚˜ì˜ ê³ ìœ ë²ˆí˜¸" />
      <input id="login-pin" inputmode="numeric" pattern="[0-9]*" placeholder="ë¹„ë°€ë²ˆí˜¸(4ìë¦¬)" maxlength="4" />
    </div>
    <div class="spacer"></div>
    <div class="row">
      <button class="btn" id="signup-btn">ë“±ë¡í•˜ê¸°</button>
      <button class="btn-primary" id="login-btn">ë¡œê·¸ì¸</button>
    </div>
    <div class="spacer"></div>
    <div class="center">
      <button id="admin-entry-btn" class="btn-accent small">ê´€ë¦¬ì</button>
    </div>
    <div class="spacer"></div>
    <p class="subtitle small"><br/>ì´ë²¤íŠ¸ìš© ìµëª… ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.<br/>BETA SERVICE @higher_itaewon<br/></p>
  </section>

  <!-- (ë””ìì¸ ë³€ê²½ìœ¼ë¡œ ì˜ˆì „ ìƒë‹¨ë°”ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŒ) -->
  <div id="topbar-common" class="hidden"></div>

  <!-- ===== [PAGE] ë©”ë‰´ ===== -->
  <section id="page-menu" class="card hidden">
    <div class="grid">
      <button class="tile" id="btn-profile">
        <strong>í”„ë¡œí•„ ì„¤ì •í•˜ê¸°</strong>
        <span class="muted small">ìê¸°ì†Œê°œÂ·ì´ìƒí˜•</span>
      </button>
      <button class="tile" id="btn-browse">
        <strong>ë‹¤ë¥¸ì‚¬ëŒ êµ¬ê²½í•˜ê¸°</strong>
        <span class="muted small">ë²ˆí˜¸ìˆœ í”„ë¡œí•„</span>
      </button>
      <button class="tile like" id="btn-like">
        <strong>ğŸ‘LIKE ë³´ë‚´ê¸°</strong>
        <span class="muted small">ë²ˆí˜¸ ì…ë ¥í•˜ì—¬ ì „ì†¡</span>
      </button>
      <button class="tile" id="btn-matches">
        <strong>ë‚˜ì˜ MATCH ğŸ’›</strong>
        <span class="muted small">ë§Œë‚¨ ìš”ì²­/ìˆ˜ë½</span>
      </button>
    </div>

    <p id="login-status-menu" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <span></span>
      <button id="logout-btn" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] í”„ë¡œí•„ ì„¤ì •í•˜ê¸° ===== -->
  <section id="page-profile" class="card hidden">
    <img class="logo-mini" id="logo-mini-profile" alt="ë¡œê³ " />
    <h2 class="page-title">í”„ë¡œí•„ ì„¤ì •í•˜ê¸°</h2>

    <p class="muted">ë‚´ ê³ ìœ ë²ˆí˜¸: <span class="badge" id="me-uid-profile"></span><br/>*ë¯¼ê°í•˜ê±°ë‚˜ ë¶ˆì¾Œê°ì„ ì¤„ ìˆ˜ ìˆëŠ” ë‚´ìš© ì‘ì„±ì€ ìì œë°”ëë‹ˆë‹¤.</p>
    <textarea id="intro" maxlength="50" placeholder="ìê¸°ì†Œê°œ (ìµœëŒ€ 50ì) ex.ì˜¤ëŠ˜ ë²ˆê°œ êµ¬í•´ìš”."></textarea>
    <div class="spacer"></div>
    <textarea id="ideal" maxlength="50" placeholder="ì´ìƒí˜• (ìµœëŒ€ 50ì) ex. ì§§ì€ ë¨¸ë¦¬ ê°ììƒ"></textarea>

    <p id="login-status-profile-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="spacer"></div>
    <div class="row">
      <button class="btn" id="profile-cancel">ì·¨ì†Œ</button>
      <button class="btn-primary" id="profile-save">ì €ì¥</button>
    </div>
    <div class="footerbar">
      <button id="to-menu1" class="btn small">ë’¤ë¡œê°€ê¸° â†©ï¸</button>
      <button id="logout-btn1" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] ë‹¤ë¥¸ì‚¬ëŒ êµ¬ê²½í•˜ê¸° ===== -->
  <section id="page-browse" class="card hidden">
    <img class="logo-mini" id="logo-mini-browse" alt="ë¡œê³ " />
    <h2 class="page-title">ë‹¤ë¥¸ì‚¬ëŒ êµ¬ê²½í•˜ê¸°</h2>
   <div class="footerbar">
      <button id="to-menu2" class="btn small">ë’¤ë¡œê°€ê¸° â†©ï¸</button>
      <button id="logout-btn2" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
    <div id="browse-list" class="list"></div>

    <p id="login-status-browse-top" class="center muted small" style="margin-top:12px;"></p>

    
  </section>

  <!-- ===== [PAGE] LIKE ë³´ë‚´ê¸° ===== -->
  <section id="page-like" class="card hidden">
    <img class="logo-mini" id="logo-mini-like" alt="ë¡œê³ " />
    <h2 class="page-title">ğŸ‘LIKE ë³´ë‚´ê¸°</h2>

    <div class="row">
      <input id="from-like" disabled />
      <input id="to-like" inputmode="numeric" pattern="[0-9]*" placeholder="ìƒëŒ€ ê³ ìœ ë²ˆí˜¸ ì…ë ¥" />
    </div>
    <div class="spacer"></div>
    <button id="send-like-btn" class="btn-like btn-focus">LIKE ë³´ë‚´ê¸°</button>
    <p class="muted small" style="margin-top:10px;">â€» ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë²ˆí˜¸ë¡œëŠ” ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>

    <p id="login-status-like-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <button id="to-menu3" class="btn small">ë’¤ë¡œê°€ê¸° â†©ï¸</button>
      <button id="logout-btn3" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] ë‚˜ì˜ MATCH í˜„í™©ë³´ê¸° ===== -->
  <section id="page-matches" class="card hidden">
    <img class="logo-mini" id="logo-mini-matches" alt="ë¡œê³ " />
    <h2 class="page-title">ë‚˜ì˜ MATCH í˜„í™© ğŸ’›</h2>

    <div id="matches-list" class="list"></div>

    <p id="login-status-matches-top" class="center muted small" style="margin-top:12px;"></p>

    <div class="footerbar">
      <button id="to-menu4" class="btn small">ë’¤ë¡œê°€ê¸° â†©ï¸</button>
      <button id="logout-btn4" class="btn small">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </section>

  <!-- ===== [PAGE] ê´€ë¦¬ì ê²Œì´íŠ¸ ===== -->
  <section id="page-admin-gate" class="card hidden">
    <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
    <p class="muted small">ê´€ë¦¬ì ìê²©ì€ ì½”ë“œ ë‚´ë¶€ì— ê³ ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</p>
    <div class="row">
      <input id="admin-id" placeholder="ê´€ë¦¬ì ì•„ì´ë””" />
      <input id="admin-pw" placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸" type="password" />
    </div>
    <div class="spacer"></div>
    <div class="row">
      <button id="admin-cancel" class="btn">ì·¨ì†Œ</button>
      <button id="admin-login" class="btn-primary">ê´€ë¦¬ì ì ‘ì†</button>
    </div>
  </section>

  <!-- ===== [PAGE] ê´€ë¦¬ì ===== -->
  <section id="page-admin" class="card hidden">
    <h2>ê´€ë¦¬ì í˜ì´ì§€</h2>
    <div class="spacer"></div>
    <div class="row">
      <input id="event-id-input" placeholder="ì´ë²¤íŠ¸ ID (ì˜ˆ: 2025-10-05-night)" />
      <button id="apply-event-id" class="btn">ì´ë²¤íŠ¸ID ì ìš©</button>
    </div>
    <p class="small muted">í˜„ì¬ ì´ë²¤íŠ¸: <span class="badge" id="current-event"></span></p>

    <h3 style="margin-top:16px">ë§¤ì¹˜ í˜„í™©(ìŒë°©)</h3>
    <div id="admin-matches" class="list"></div>
    <p class="small">ì´ ì»¤í”Œ ìˆ˜: <span class="count" id="admin-match-count">0</span></p>

    <h3 style="margin-top:16px">ê°œë³„ ì‚¬ìš©ì ì‚­ì œ</h3>
    <div class="row">
      <input id="admin-del-uid" placeholder="ì‚­ì œí•  ê³ ìœ ë²ˆí˜¸" inputmode="numeric" pattern="[0-9]*" />
      <button id="admin-del-user" class="btn-danger">í•´ë‹¹ ì‚¬ìš©ì ë°ì´í„° ì‚­ì œ</button>
    </div>

    <h3 style="margin-top:16px">ì´ë²¤íŠ¸ ì „ì²´ ì´ˆê¸°í™”</h3>
    <button id="admin-reset" class="btn-danger">ëª¨ë“  ê³„ì •/ë°ì´í„° ì™„ì „ ì‚­ì œ</button>

    <div class="spacer"></div>
    <button id="admin-logout" class="btn small">ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ</button>
  </section>

</div>

<!-- ===== ê¸°ë³¸ ëª¨ë‹¬ ===== -->
<div id="modal" class="modal-backdrop">
  <div class="modal">
    <h3 id="modal-title">ì•Œë¦¼</h3>
    <div id="modal-message" class="muted" style="white-space:pre-line"></div>
    <div class="actions" id="modal-actions">
      <button id="modal-ok" class="btn-primary">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- ===== ë¡œë”©(ëŒ€ê¸° ì•ˆë‚´) ì˜¤ë²„ë ˆì´ ===== -->
<div id="loading" class="loading-backdrop">
  <div class="loading-box">
    <div class="spinner"></div>
    <div>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, get, set, update, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";
  import {
    getAuth, signInAnonymously, onAuthStateChanged,
    setPersistence, inMemoryPersistence
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

  // ===================== í™˜ê²½ ì„¤ì • =====================
  const firebaseConfig = {
  apiKey: "AIzaSyBAgN2C_5MS2ZbfwGfIQ7wSv2ECtaMqeDY",
  authDomain: "higher-match-1009.firebaseapp.com",
  databaseURL: "https://higher-match-1009-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "higher-match-1009",
  storageBucket: "higher-match-1009.firebasestorage.app",
  messagingSenderId: "631821248507",
  appId: "1:631821248507:web:5b038a90fd7fc9ffe94d5e",
  measurementId: "G-EMK90CY6NW"
  };

  let EVENT_ID = localStorage.getItem("hm_event_id") || "defaultEvent";
  const ADMIN_ID = "admin";
  const ADMIN_PASSWORD = "higher1011!";

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // ===================== ìƒíƒœ =====================
  let currentUid = null;
  let currentPin = null;
  let adminLoggedIn = false;
  let isConnected = null; // Realtime DB ì—°ê²° ìƒíƒœ

  // ===================== DOM í—¬í¼ =====================
  const $ = s => document.querySelector(s);
  function show(el){
    el.classList.remove("hidden");
    if (el.classList.contains("modal-backdrop") || el.classList.contains("loading-backdrop")) {
      el.style.display = "flex";
    }
  }
  function hide(el){
    el.classList.add("hidden");
    if (el.classList.contains("modal-backdrop") || el.classList.contains("loading-backdrop")) {
      el.style.display = "none";
    }
  }

  const loadingEl = $("#loading");
  const withLoading = async (fn) => { try{ show(loadingEl); await fn(); } finally{ hide(loadingEl); } };

  const pages = {
    welcome: $("#page-welcome"),
    menu: $("#page-menu"),
    profile: $("#page-profile"),
    browse: $("#page-browse"),
    like: $("#page-like"),
    matches: $("#page-matches"),
    adminGate: $("#page-admin-gate"),
    admin: $("#page-admin")
  };

  const logoMain = $("#logo-main");
  function setAllMiniLogos(){
    document.querySelectorAll(".logo-mini").forEach(img=>{
      img.src = logoMain.src;
    });
  }
  setAllMiniLogos();

  // ===================== ëª¨ë‹¬ =====================
  const modal = $("#modal");
  const modalTitle = $("#modal-title");
  const modalMsg = $("#modal-message");
  const modalActions = $("#modal-actions");

  function alertModal(message, title="ì•Œë¦¼"){
    if (loadingEl) hide(loadingEl);
    return new Promise(res=>{
      modalTitle.textContent = title;
      modalMsg.textContent = message;
      modalActions.innerHTML = `<button id="modal-ok" class="btn-primary">í™•ì¸</button>`;
      $("#modal-ok").onclick = ()=>{ hide(modal); res(true); };
      show(modal);
    });
  }
  function confirmModal(message, {okText="í™•ì¸", cancelText="ì·¨ì†Œ", title="í™•ì¸"}={}){
    if (loadingEl) hide(loadingEl);
    return new Promise(res=>{
      modalTitle.textContent = title;
      modalMsg.textContent = message;
      modalActions.innerHTML = `
        <button id="modal-cancel" class="btn">${cancelText}</button>
        <button id="modal-ok" class="btn-primary">${okText}</button>`;
      $("#modal-cancel").onclick = ()=>{ hide(modal); res(false); };
      $("#modal-ok").onclick = ()=>{ hide(modal); res(true); };
      show(modal);
    });
  }
  function choiceModal(message){
    if (loadingEl) hide(loadingEl);
    return new Promise(res=>{
      modalTitle.textContent = "ë§Œë‚¨ ìš”ì²­";
      modalMsg.textContent = message;
      modalActions.innerHTML = `
        <button id="modal-decline" class="btn-danger">ê±°ì ˆ</button>
        <button id="modal-hold" class="btn">ë³´ë¥˜</button>
        <button id="modal-accept" class="btn-primary">ìˆ˜ë½</button>
      `;
      $("#modal-decline").onclick = ()=>{ hide(modal); res(false); };
      $("#modal-hold").onclick = ()=>{ hide(modal); res(null); };
      $("#modal-accept").onclick = ()=>{ hide(modal); res(true); };
      show(modal);
    });
  }

  // ===================== ì—°ê²° ìƒíƒœ ë¼ë²¨ ì²˜ë¦¬ =====================
  function updateConnectionLabels(){
    const suffix = (isConnected===null) ? "" : (isConnected ? " Â· ì‹¤ì‹œê°„: ì—°ê²°ë¨" : " Â· ì‹¤ì‹œê°„: ì˜¤í”„ë¼ì¸");
    const base = currentUid ? `${currentUid}ë²ˆ ë‹˜ì´ ë¡œê·¸ì¸ ì¤‘ì…ë‹ˆë‹¤` : "";
    const textTop = base + suffix;

    ["#login-status-menu",
     "#login-status-profile-top",
     "#login-status-browse-top",
     "#login-status-like-top",
     "#login-status-matches-top"
    ].forEach(sel=>{ const el=$(sel); if(el) el.textContent=textTop; });

    const fromLike = $("#from-like");
    if(fromLike){ fromLike.value = currentUid ? `ë‚´ ë²ˆí˜¸: ${currentUid}` : ""; }
  }

  // ===================== DB ìœ í‹¸ =====================
  const r = (p)=> ref(db, `events/${EVENT_ID}/${p}`);
  async function getUser(uid){ const snap = await get(r(`users/${uid}`)); return snap.exists()? snap.val(): null; }
  async function userExists(uid){ return !!(await getUser(uid)); }

  // ===================== Auth ì´ˆê¸°í™” (inMemoryPersistence + ìµëª… ë¡œê·¸ì¸) =====================
  async function initAuth(){
    try{
      await setPersistence(auth, inMemoryPersistence); // âœ… iOS ê°œì¸ëª¨ë“œ/ì¸ì•± í˜¸í™˜
      await signInAnonymously(auth);
    }catch(e){
      console.error("Auth init error:", e);
      // ìŠ¤í† ë¦¬ì§€ ì œí•œ ë“±ìœ¼ë¡œ ì‹¤íŒ¨í•´ë„, ì¬ì‹œë„ëŠ” ê° ë™ì‘ ì‹œ authReadyì—ì„œ ë³´ì¥ë¨
    }
    return new Promise((resolve)=>{
      if(auth.currentUser) return resolve(auth.currentUser);
      const unsub = onAuthStateChanged(auth, (u)=>{unsub(); resolve(u);});
    });
  }
  // ì¦‰ì‹œ ì‹¤í–‰
  await initAuth();

  // ===================== .info/connected ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ =====================
  onValue(ref(db, ".info/connected"), (snap)=>{
    isConnected = (snap.val() === true);
    console.log("RTDB connected:", isConnected);
    updateConnectionLabels();
  });

  // ===================== íšŒì›ê°€ì…/ë¡œê·¸ì¸ =====================
  $("#signup-btn").onclick = async ()=>{
    await withLoading(async ()=>{
      try{
        const uid = $("#login-uid").value.trim();
        const pin = $("#login-pin").value.trim();
        if(!uid || !/^\d+$/.test(uid)) return alertModal("ê³ ìœ ë²ˆí˜¸ëŠ” ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.");
        if(!/^\d{4}$/.test(pin)) return alertModal("ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.");
        if(await userExists(uid)) return alertModal("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë²ˆí˜¸ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.");
        await set(r(`users/${uid}`), { pin, intro:"", ideal:"", createdAt: Date.now() });
        await alertModal("ê³„ì •ì´ ìƒì„± ë˜ì—ˆìŠµë‹ˆë‹¤.");
      }catch(err){
        console.error(err);
        const msg = (err && err.message) ? err.message : String(err);
        if(String(err && err.code).includes("permission_denied")){
          alertModal("ë°ì´í„°ë² ì´ìŠ¤ ê¶Œí•œ ì˜¤ë¥˜ì…ë‹ˆë‹¤.\n- Authentication: Anonymous í™œì„±í™” í™•ì¸\n- Database ê·œì¹™(.read/.write) í™•ì¸", "ê¶Œí•œ ì˜¤ë¥˜");
        }else if(msg.includes("databaseURL")){
          alertModal("firebaseConfig.databaseURLì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.", "ì„¤ì • ì˜¤ë¥˜");
        }else{
          alertModal("ë“±ë¡í•˜ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + msg, "ì˜¤ë¥˜");
        }
      }
    });
  };

  $("#login-btn").onclick = async ()=>{
    await withLoading(async ()=>{
      try{
        const uid = $("#login-uid").value.trim();
        const pin = $("#login-pin").value.trim();
        if(!uid) return alertModal("ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
        const user = await getUser(uid);
        if(!user){ return alertModal("í•´ë‹¹ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."); }
        if(user.pin !== pin){ return alertModal("ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤."); }
        currentUid = uid; currentPin = pin;
        attachRealtimeListeners();
        go("menu");
      }catch(err){
        console.error(err);
        alertModal("ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + ((err && err.message) ? err.message : String(err)));
      }
    });
  };

  // ë¡œê·¸ì•„ì›ƒ
  function doLogout(){
    detachRealtimeListeners();
    currentUid = null; currentPin = null;
    go("welcome");
  }
  ["#logout-btn","#logout-btn1","#logout-btn2","#logout-btn3","#logout-btn4"].forEach(sel=>{
    const el = $(sel); if(el) el.onclick = doLogout;
  });

  // ê° í˜ì´ì§€ì˜ â€œë©”ë‰´â€ ë²„íŠ¼ â†’ ë©”ë‰´ë¡œ ì´ë™
  ["#to-menu1","#to-menu2","#to-menu3","#to-menu4"].forEach(sel=>{
    const el = $(sel); if(el) el.onclick = ()=> go("menu");
  });

  // ë©”ë‰´ ì´ë™
  $("#btn-profile").onclick = ()=>{ $("#me-uid-profile").textContent = currentUid; loadProfile(); go("profile"); };
  $("#btn-browse").onclick = ()=>{ loadBrowse(); go("browse"); };
  $("#btn-like").onclick   = ()=>{ $("#from-like").value=`ë‚´ ë²ˆí˜¸: ${currentUid}`; $("#to-like").value=""; go("like"); };
  $("#btn-matches").onclick= ()=>{ loadMatches(); go("matches"); };

  // í”„ë¡œí•„ ì €ì¥/ì·¨ì†Œ
  async function loadProfile(){
    const u = await getUser(currentUid);
    $("#intro").value = (u && u.intro)||"";
    $("#ideal").value = (u && u.ideal)||"";
  }
  $("#profile-save").onclick = async ()=>{
    await withLoading(async ()=>{
      await update(r(`users/${currentUid}`), {
        intro: $("#intro").value.trim().slice(0,50),
        ideal: $("#ideal").value.trim().slice(0,50)
      });
      await alertModal("í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      go("menu");
    });
  };
  $("#profile-cancel").onclick = ()=>go("menu");

  // ë‹¤ë¥¸ì‚¬ëŒ êµ¬ê²½
  async function loadBrowse(){
    const wrap = $("#browse-list");
    wrap.innerHTML = "";
    const snap = await get(r("users"));
    if(!snap.exists()){ wrap.innerHTML = `<div class="muted small">ì•„ì§ ê°€ì…ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
    const users = snap.val();
    const ids = Object.keys(users).filter(id=>id!==currentUid).sort((a,b)=>Number(a)-Number(b));
    ids.forEach(id=>{
      const u = users[id];
      const item = document.createElement("div");
      item.className="list-item";
      item.innerHTML = `
        <div class="li-content">
          <div><strong>${id}ë²ˆ</strong></div>
          <div class="small muted" style="margin-top:4px;">ìê¸°ì†Œê°œ: ${u.intro||"-"}</div>
          <div class="small muted" style="margin-top:2px;">ì´ìƒí˜•: ${u.ideal||"-"}</div>
        </div>
        <div class="li-actions">
          <button class="btn-like small" data-like="${id}">ğŸ‘LIKE</button>
        </div>
      `;
      wrap.appendChild(item);
    });
    wrap.querySelectorAll("[data-like]").forEach(btn=>{
      btn.onclick = ()=> sendLike(btn.getAttribute("data-like"));
    });
  }

  // LIKE ë³´ë‚´ê¸°
  $("#send-like-btn").onclick = async ()=>{
    const toId = $("#to-like").value.trim();
    if(!/^\d+$/.test(toId)) return alertModal("ìƒëŒ€ ê³ ìœ ë²ˆí˜¸ë¥¼ ìˆ«ìë¡œ ì…ë ¥í•˜ì„¸ìš”.");
    await withLoading(async ()=>{ await sendLike(toId); });
  };

  async function sendLike(toId){
    if(toId===currentUid) return alertModal("ë³¸ì¸ì—ê²ŒëŠ” ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    const exists = await userExists(toId);
    if(!exists) return alertModal("í•´ë‹¹ ë²ˆí˜¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.");
    await set(r(`likes/${currentUid}/${toId}`), true);

    const reciprocal = await get(r(`likes/${toId}/${currentUid}`));
    if(reciprocal.exists()){
      const payload = {status:"matched", updatedAt: Date.now()};
      await update(r(`matches/${currentUid}/${toId}`), payload);
      await update(r(`matches/${toId}/${currentUid}`), payload);
      alertModal(`${toId}ë²ˆ ì‚¬ìš©ìì™€ MATCHê°€ ë˜ì—ˆìŠµë‹ˆë‹¤! ë§¤ì¹˜ í˜„í™©ì„ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`);
    }else{
      await alertModal("LIKEê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }
  }

  // ë‚˜ì˜ MATCH í˜„í™©
  async function loadMatches(){
    const wrap = $("#matches-list");
    wrap.innerHTML = "";
    const snap = await get(r(`matches/${currentUid}`));
    if(!snap.exists()){ wrap.innerHTML = `<div class="muted small">ì•„ì§ ë§¤ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
    const list = snap.val();
    const ids = Object.keys(list).sort((a,b)=>Number(a)-Number(b));
    ids.forEach(other=>{
      const m = list[other];
      const row = document.createElement("div");
      row.className="list-item";
      let right = "";
      if(m.status==="matched"){
        right = `<button class="btn-success small" data-meet="${other}">ë§Œë‚¨ ìš”ì²­í•˜ê¸°</button>`;
      }else if(m.status==="meeting_requested"){
        right = `<span class="small badge">ìš”ì²­ ì§„í–‰ì¤‘</span>`;
      }else if(m.status==="meeting_accepted"){
        right = `
          <span class="small badge" style="background:#14532d;border-color:#1d7a49">ë§Œë‚¨ ì„±ì‚¬</span>
          <button class="btn small" data-staff="${other}">ì§ì›<br/>í™•ì¸</button>
        `;
      }
      row.innerHTML = `
        <div class="li-content">
          <div><strong>${other}ë²ˆ</strong></div>
          <div class="small muted">ìƒíƒœ: ${statusKorean(m.status)}</div>
        </div>
        <div class="li-actions">${right}</div>
      `;
      wrap.appendChild(row);
    });

    wrap.querySelectorAll("[data-meet]").forEach(btn=>{
      btn.onclick = async ()=>{
        const target = btn.getAttribute("data-meet");
        await withLoading(async ()=>{
          await set(r(`meetingRequests/${target}/${currentUid}`), {status:"pending", updatedAt: Date.now()});
          await update(r(`matches/${currentUid}/${target}`), {status:"meeting_requested", updatedAt: Date.now()});
        });
        await alertModal("ë§Œë‚¨ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadMatches();
      };
    });

    wrap.querySelectorAll("[data-staff]").forEach(btn=>{
      btn.onclick = async ()=>{
        const other = btn.getAttribute("data-staff");
        const ok = await confirmModal("ì§ì›í™•ì¸ì´ ì™„ë£Œë˜ë©´ ë§¤ì¹˜í˜„í™©ì€ ì‚­ì œë©ë‹ˆë‹¤. ê·¸ë˜ë„ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",{okText:"í™•ì¸",cancelText:"ì·¨ì†Œ"});
        if(!ok) return;
        await withLoading(async ()=>{ await clearPairData(currentUid, other); });
        await alertModal("ë§¤ì¹˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        loadMatches();
      };
    });
  }

  function statusKorean(s){
    return s==="matched" ? "ë§¤ì¹˜ë¨"
      : s==="meeting_requested" ? "ë§Œë‚¨ ìš”ì²­ ì¤‘"
      : s==="meeting_accepted" ? "ë§Œë‚¨ ì„±ì‚¬"
      : s;
  }

  async function clearPairData(a,b){
    const ops = [
      remove(r(`matches/${a}/${b}`)),
      remove(r(`matches/${b}/${a}`)),
      remove(r(`likes/${a}/${b}`)),
      remove(r(`likes/${b}/${a}`)),
      remove(r(`meetingRequests/${a}/${b}`)),
      remove(r(`meetingRequests/${b}/${a}`))
    ];
    await Promise.all(ops);
  }

  // ===================== ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ =====================
  let detachFns = [];
  function attachRealtimeListeners(){
    detachRealtimeListeners();
    if(!currentUid) return;

    // ë‚´ ë§¤ì¹˜ ìƒíƒœ ë³€í™”
    const off1 = onValue(r(`matches/${currentUid}`), snap=>{
      if(!snap.exists()) return;
      const data = snap.val();
      Object.entries(data).forEach(([other, m])=>{
        if(m && m.status==="matched" && (Date.now()-m.updatedAt)<4000){
          alertModal(`${other}ë²ˆ ì‚¬ìš©ìì™€ MATCHê°€ ë˜ì—ˆìŠµë‹ˆë‹¤! ë§¤ì¹˜ í˜„í™©ì„ í™•ì¸í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.`);
        }
        if(m && m.status==="meeting_accepted" && (Date.now()-m.updatedAt)<4000){
          alertModal("ë§Œë‚¨ì´ ì„±ì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ê¸ˆë°”ë¡œ ë§Œë‚¨ì„ ìœ„í•´ ì§ì›ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”!");
        }
      });
      if(!pages.matches.classList.contains("hidden")) loadMatches();
    });
    detachFns.push(()=>off1());

    // ë‚´ê°€ ë°›ì€ ë§Œë‚¨ ìš”ì²­
    const off2 = onValue(r(`meetingRequests/${currentUid}`), async snap=>{
      if(!snap.exists()) return;
      const reqs = snap.val();
      for(const fromUid of Object.keys(reqs)){
        const req = reqs[fromUid];
        if(req.status==="pending"){
          const accepted = await choiceModal(`${fromUid}ë²ˆê³¼ì˜ ë§Œë‚¨ ìš”ì²­ì„ ìˆ˜ë½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
          if(accepted===true){
            await update(r(`matches/${currentUid}/${fromUid}`), {status:"meeting_accepted", updatedAt: Date.now()});
            await update(r(`matches/${fromUid}/${currentUid}`), {status:"meeting_accepted", updatedAt: Date.now()});
            await remove(r(`meetingRequests/${currentUid}/${fromUid}`));
            await alertModal("ë§Œë‚¨ì´ ì„±ì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì§€ê¸ˆë°”ë¡œ ë§Œë‚¨ì„ ìœ„í•´ ì§ì›ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”!");
          }else if(accepted===false){
            await clearPairData(currentUid, fromUid);
          }else{
            // ë³´ë¥˜: ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
          }
        }
      }
      if(!pages.matches.classList.contains("hidden")) loadMatches();
    });
    detachFns.push(()=>off2());

    updateConnectionLabels(); // ì ‘ì† ì§í›„ ìƒíƒœ ë°˜ì˜
  }
  function detachRealtimeListeners(){
    detachFns.forEach(fn=>{ try{fn();}catch{} });
    detachFns = [];
    updateConnectionLabels();
  }

  // ===================== ê´€ë¦¬ì =====================
  $("#admin-entry-btn").onclick = ()=> go("adminGate");
  $("#admin-cancel").onclick = ()=> go("welcome");
  $("#admin-login").onclick = ()=>{
    const id = $("#admin-id").value.trim();
    const pw = $("#admin-pw").value.trim();
    if(id===ADMIN_ID && pw===ADMIN_PASSWORD){
      adminLoggedIn = true;
      $("#current-event").textContent = EVENT_ID;
      go("admin");
      renderAdminMatches();
    }else{
      alertModal("ê´€ë¦¬ì ì¸ì¦ ì‹¤íŒ¨");
    }
  };
  $("#admin-logout").onclick = ()=>{ adminLoggedIn = false; go("welcome"); };

  $("#apply-event-id").onclick = ()=>{
    const v = $("#event-id-input").value.trim();
    if(!v) return alertModal("ì´ë²¤íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    EVENT_ID = v;
    localStorage.setItem("hm_event_id", EVENT_ID);
    $("#current-event").textContent = EVENT_ID;
    alertModal("ì´ë²¤íŠ¸ IDê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
    if(adminLoggedIn) renderAdminMatches();
  };

  // ê´€ë¦¬ì: ì „ì—­ í•¸ë“¤ëŸ¬
  $("#admin-del-user").onclick = async ()=>{
    const uid = $("#admin-del-uid").value.trim();
    if(!uid) return alertModal("ì‚­ì œí•  ê³ ìœ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
    await withLoading(async ()=>{
      const ops = [ remove(r(`users/${uid}`)) ];
      const likesAll = await get(r(`likes`));
      ops.push(remove(r(`likes/${uid}`)));
      if(likesAll.exists()){
        const all = likesAll.val();
        for(const from of Object.keys(all)){
          if(all[from] && all[from][uid]){
            ops.push(remove(r(`likes/${from}/${uid}`)));
          }
        }
      }
      const mA = await get(r(`matches/${uid}`));
      if(mA.exists()){
        const others = Object.keys(mA.val());
        others.forEach(other=>{
          ops.push(remove(r(`matches/${uid}/${other}`)));
          ops.push(remove(r(`matches/${other}/${uid}`)));
        });
      }
      ops.push(remove(r(`meetingRequests/${uid}`)));
      const reqAll = await get(r(`meetingRequests`));
      if(reqAll.exists()){
        const all = reqAll.val();
        for(const target of Object.keys(all)){
          if(all[target] && all[target][uid]){
            ops.push(remove(r(`meetingRequests/${target}/${uid}`)));
          }
        }
      }
      await Promise.all(ops);
    });
    await alertModal("í•´ë‹¹ ì‚¬ìš©ìì˜ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    if(adminLoggedIn) renderAdminMatches();
  };

  $("#admin-reset").onclick = async ()=>{
    const ok = await confirmModal("ì´ ì´ë²¤íŠ¸ì˜ ëª¨ë“  ê³„ì •ê³¼ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", { okText:"ì´ˆê¸°í™”", cancelText:"ì·¨ì†Œ", title:"ì „ì²´ ì´ˆê¸°í™”" });
    if(!ok) return;
    await withLoading(async ()=>{
      await remove(r(`users`));
      await remove(r(`likes`));
      await remove(r(`matches`));
      await remove(r(`meetingRequests`));
    });
    await alertModal("ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    if(adminLoggedIn) renderAdminMatches();
  };

  // ê´€ë¦¬ì ë§¤ì¹˜ í˜„í™© ë Œë”
  async function renderAdminMatches(){
    const box = $("#admin-matches");
    box.innerHTML = "";
    let pairs = new Set();
    let count = 0;

    const all = await get(r("matches"));
    if(!all.exists()){
      box.innerHTML = `<div class="muted small">í˜„ì¬ ë§¤ì¹˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      $("#admin-match-count").textContent = "0";
      return;
    }
    const data = all.val();

    for(const a of Object.keys(data)){
      const others = data[a];
      for(const b of Object.keys(others)){
        const st = (others[b] && others[b].status) || "";
        if(st==="meeting_accepted" || st==="matched"){
          const key = [Math.min(+a,+b), Math.max(+a,+b)].join("-");
          if(pairs.has(key)) continue;
          pairs.add(key);
          count++;
          const item = document.createElement("div");
          item.className="list-item";
          item.innerHTML = `<div class="li-content"><strong>${a}ë²ˆ â†” ${b}ë²ˆ</strong> <span class="small badge">${st==="meeting_accepted"?"ë§Œë‚¨ ì„±ì‚¬":"ë§¤ì¹˜ë¨"}</span></div>`;
          box.appendChild(item);
        }
      }
    }
    if(count===0){
      box.innerHTML = `<div class="muted small">í˜„ì¬ ë§¤ì¹˜ëœ ì»¤í”Œì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }
    $("#admin-match-count").textContent = String(count);
  }

  // ===================== í˜ì´ì§€ ì „í™˜ =====================
  function go(id){
    Object.values(pages).forEach(hide);
    show(pages[id]);
    updateConnectionLabels();
  }

  // ì‹œì‘ í˜ì´ì§€
  go("welcome");
</script>
</body>

</html>
